<div id="postDetails" class="col6 <%= @post.open_class %>">

  <div class="row contentHeader">
    <div class="innerHeader row">
      <header class="col3 pull_left">
        <h1><%= @post.hashtag_prefix %></h1>
      </header>
      <p id="postStatus" class="col3 <%= @post.open? %> pull_right">
        <% if @post.open? %>
            Open
        <% else %>
            Closed
        <% end %>
      </p>
    </div>
  </div>
  <!-- contentHeader End-->

  <div id="postDetailInner" class="row">

    <div id="postImageWrapper" class="col3 pull_right">

      <div id="addPhotoControlGroup">
        <!-- if false to prevent this until we want to implement it-->
        <% if false and not @post.has_photo? and signed_in? and @post.user_id == current_user.id %>
            <%= form_for(@additional_photo, :url => url_for(:controller => :additional_photos, :action => :add), :id => 'addImageForm') do |f| %>
                <%= f.file_field :photo, style: "position:absolute; top:-999px; left:-999px" %>
                <%= link_to image_tag('plus_button.png'), '#', :class => 'pull_right', :id => "photoSelect" %>
                <%= hidden_field_tag :post_id, params[:id] %>
            <% end %>
        <% end %>
      </div>

      <% if @post.photo_file_name.blank? %>
          <div id="placeholderWrapper">
            <%= image_tag "noPhoto_300x300.png", :id => "placeholderImg", :height => "auto", :width => "100%" %>
            <% if current_user?(@post.user) and @post.open? %>
                <%= form_for @post do |f| %>
                    <fieldset id="photoControlGroup" class="col6 pull_left">
                      <div class="controls thumbnail pull_left">
                        <!--[if lt IE 9]>
                    <%= f.file_field :photo %>
                  <![endif]-->
                        <!--[if gt IE 9]><!-->
                        <%= f.file_field :photo, style: "position:absolute; top:-999px; left:-999px" %>
                        <a href="#" id="fileSelect" class="pull_left">Add photo</a>
                        <!--<![endif]-->
                      </div>
                    </fieldset>
                <% end %>
            <% end %>
          </div>

      <% else %>
          <%= image_tag @post.photo.url(:medium), :class => "img_border", :height => "auto", :width => "100%", :id => 'post_mainImage' %>
      <% end %>

    </div>
    <!-- postImageWrapper End -->

    <div id="postInfo" class="col3 pull_left">
      <dl>
        <dt class="col2">Location</dt>
        <% if signed_in? and @post.user_id == current_user.id %>
            <dd class="col3 editable" edit_field="location"><%= @post.location %></dd>
        <% else %>
            <dd class="col3" edit_field="location"><%= @post.location %></dd>
        <% end %>

        <dt class="col2">Price</dt>
        <% if signed_in? and @post.user_id == current_user.id %>
            <dd class="col3 editable" edit_field="price">$<%= number_with_delimiter(@post.price, :delimiter => ',') %></dd>
        <% else %>
            <dd class="col3" edit_field="price">$<%= number_with_delimiter(@post.price, :delimiter => ',') %></dd>
        <% end %>

        <dt class="col2">Interested</dt>
        <dd class="col3"><%= @post.interested %></dd>
      </dl>
    </div>
    <!-- postInfo End -->

    <div id="postDescription" class="col3">
      <p class="col6"><%= @post.content %></p>
      <% if signed_in? && !current_user?(@post.user) %>
          <div class="row">
            <% if !current_user.post_in_watch_list?(@post.id) %>
                <%= link_to "Watch", {:controller => :watchedposts, :action => :interested, :post => @post.id}, class: "col2 btn_ltGrey" %>
            <% else %>
                <%= link_to "Unwatch", {:controller => :watchedposts, :action => :uninterested, :post => @post.id}, class: "col2 btn_ltGrey" %>
            <% end %>
          </div>
      <% end %>
    </div>
    <!-- postDescription End -->

  </div>
  <!-- postDetailInner end -->

  <div id='post_imagePort'></div>
</div>

<script type='text/javascript'>
    $(document).ready(function () {
        window.startPostZoomer()

        $('[class~=editable]').dblclick(function (e) {
            swapVal = e.target.innerHTML;
            edit_field = e.target.getAttribute('edit_field');
            maxlength = 16
            if (edit_field == 'price') {
                maxlength = 6
                swapVal = swapVal.replace('$', '');
            }

            e.target.innerHTML = '<input maxlength="' + maxlength.toString() + ' type="text" style="font-size: 0.9em" id="' + edit_field + '_edit_active" value="' + swapVal + '"/>'
            active_textbox = $('#' + edit_field + '_edit_active');
            active_textbox.focus();
            active_textbox.keypress(
                    function (key_enter) {
                        if ((key_enter.keyCode || key_enter.which) == 13) {
                            closeTextbox(active_textbox, swapVal, edit_field, e);
                        }else if((key_enter.keyCode || key_enter.which) == 27) {
                            alert('steve')
                            e.target.innerHTML = '$' + swapVal;
                        }
                    }).blur(function () {
                        closeTextbox(active_textbox, swapVal, edit_field, e);
                    })
        });
    })

    function closeTextbox(active_textbox, swapVal, edit_field, e) {
            if (active_textbox.val() != swapVal && validateEditField(edit_field, active_textbox.val())) {
                $.ajax({
                    url:'<%= url_for :controller => :posts, :action => :edit_field, :id => @post.id_hash %>',
                    type:"POST",
                    data:'field=' + edit_field + '&value=' + active_textbox.val(),
                    complete:function (requestObj, textStatus) {
                        e.target.innerHTML = requestObj.responseText;
                    }
                });
            } else {
                if (edit_field == 'price') {
                    e.target.innerHTML = '$' + swapVal.toString();
                } else {
                    e.target.innerHTML = swapVal.toString();
                }
            }

    }

    function validateEditField(edit_field, value) {
        value.replace(/\s+/g, ' ');
        if (value.length == 0) {
            return false;
        }

        if (edit_field == 'location') {
            if (value.length <= 16) {
                return true;
            }
        } else if (edit_field == 'price') {
            if (value.length <= 6 && parseInt(value, 10) > 0) {
                return true;
            }
        }
        return false;
    }
</script>

